#!/bin/bash
set -euo pipefail

BASE_DIR="$(cd "$(dirname "$0")" && pwd)"
OUT_DIR="$BASE_DIR"

POKEMONS=(Bulbasaur Ivysaur Venusaur Charmander Charmeleon)
MAX_RETRIES=5
INITIAL_BACKOFF=1   # seconds
DELAY_BETWEEN=1     # seconds between successful requests

for p in "${POKEMONS[@]}"; do
  name_lc=$(printf '%s' "$p" | tr '[:upper:]' '[:lower:]')
  url="https://pokeapi.co/api/v2/pokemon/$name_lc"
  dest="$OUT_DIR/$name_lc.json"
  tmp=$(mktemp)
  retries=0
  backoff=$INITIAL_BACKOFF

  while :; do
    http_code=$(curl -sS -w '%{http_code}' -o "$tmp" "$url" || printf '000')
    if [ "$http_code" = "200" ]; then
      mv -f "$tmp" "$dest"
      printf 'Saved %s\n' "$dest"
      break
    elif [ "$http_code" = "429" ]; then
      retries=$((retries+1))
      if [ "$retries" -gt "$MAX_RETRIES" ]; then
        printf 'Rate limited: giving up on %s after %d retries\n' "$p" "$MAX_RETRIES" >&2
        rm -f "$tmp"
        break
      fi
      printf 'Rate limited (429) for %s â€” retry %d/%d after %ds\n' "$p" "$retries" "$MAX_RETRIES" "$backoff" >&2
      sleep "$backoff"
      backoff=$((backoff * 2))
      continue
    else
      printf 'Failed to fetch %s: HTTP %s\n' "$p" "$http_code" >&2
      rm -f "$tmp"
      break
    fi
  done

  sleep "$DELAY_BETWEEN"
done
